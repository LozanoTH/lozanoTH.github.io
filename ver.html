<!DOCTYPE html>
<html lang="es">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<head>
  <meta charset="UTF-8">
  <title>redirect</title>
</head>

<body>

  <script>
    (async () => {
      const id = new URLSearchParams(location.search).get("id");
      if (!id) {
        document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>Error: Enlace no válido (falta ID)</h3>";
        return;
      }

      const url = `https://lozano-1690859356322-default-rtdb.firebaseio.com/pages/${id}.json`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data || !data.redirect) {
          document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>Error: El enlace no existe o ha sido eliminado.</h3>";
          return;
        }

        // 0. Obtener ubicación (País)
        let country = "Desconocido";
        try {
          // Timeout de 1.5s para no bloquear
          const geoController = new AbortController();
          const timeoutId = setTimeout(() => geoController.abort(), 1500);

          const geoRes = await fetch("https://ipapi.co/json/", { signal: geoController.signal });
          const geoData = await geoRes.json();
          clearTimeout(timeoutId);

          if (geoData && geoData.country_name) {
            country = geoData.country_name;
          }
        } catch (e) {
          console.log("Geo skip", e);
        }

        // 1. Guardar analíticas
        const visitData = {
          timestamp: Date.now(),
          referrer: document.referrer || "directo",
          userAgent: navigator.userAgent,
          country: country
        };

        // Await para asegurar que se guarde antes de salir
        await fetch(`https://lozano-1690859356322-default-rtdb.firebaseio.com/pages/${id}/analytics.json`, {
          method: "POST",
          body: JSON.stringify(visitData)
        });

        // 2. Contador simple (sin await para agilizar)
        const newViews = (data.views || 0) + 1;
        fetch(`https://lozano-1690859356322-default-rtdb.firebaseio.com/pages/${id}/views.json`, {
          method: "PUT",
          body: JSON.stringify(newViews)
        });

        // 3. Redireccionar
        location.replace(data.redirect);

      } catch (e) {
        console.error(e);
        document.body.innerHTML = "<h3 style='text-align:center; margin-top:50px;'>Error de conexión. Intenta recargar.</h3>";
      }
    })();
  </script>

</body>

</html>