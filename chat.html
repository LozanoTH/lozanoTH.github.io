<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chat</title>
  <style>
    :root {
      --primary: #007aff;
      --bg: #ffffff;
      --text: #1d1d1f;
      --grey: #f5f5f7;
      --border: #f5f5f7;
    }

    body.dark {
      --bg: #000000;
      --text: #ffffff;
      --grey: #1c1c1e;
      --border: #2c2c2e;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      transition: background 0.3s, color 0.3s;
    }

    body {
      font-family: -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding-top: 60px;
    }

    .top-nav {
      position: fixed;
      top: 0;
      width: 100%;
      height: 60px;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid var(--border);
      z-index: 100;
      display: flex;
      align-items: center;
      padding: 0 24px;
      justify-content: space-between;
    }

    body.dark .top-nav {
      background: rgba(0, 0, 0, 0.8);
    }

    .nav-title {
      font-weight: 700;
      font-size: 19px;
    }

    #chat {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .m {
      max-width: 80%;
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 15px;
      line-height: 1.4;
      cursor: pointer;
      position: relative;
    }

    .me {
      align-self: flex-end;
      background: var(--primary);
      color: white;
    }

    .ot {
      align-self: flex-start;
      background: var(--grey);
    }

    .u {
      font-size: 11px;
      font-weight: 700;
      opacity: 0.6;
      margin-bottom: 2px;
    }

    .t {
      font-size: 10px;
      opacity: 0.6;
      text-align: right;
      margin-top: 4px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    .del-btn {
      color: #ff3b30;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
    }

    .me .del-btn {
      color: white;
      text-decoration: underline;
    }

    .re-box {
      background: rgba(0, 0, 0, 0.05);
      padding: 6px 10px;
      border-left: 3px solid var(--primary);
      border-radius: 4px;
      font-size: 12px;
      margin-bottom: 6px;
    }

    .me .re-box {
      background: rgba(255, 255, 255, 0.2);
      border-left-color: white;
      color: white;
    }

    body.dark .ot .re-box {
      background: rgba(255, 255, 255, 0.05);
    }

    .re-u {
      font-weight: 700;
      font-size: 10px;
    }

    .re-t {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      opacity: 0.8;
    }

    .input-area {
      border-top: 1px solid var(--border);
      background: var(--bg);
    }

    #re-pre {
      display: none;
      padding: 12px 24px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .re-close {
      position: absolute;
      right: 24px;
      top: 12px;
      color: var(--primary);
      font-weight: 700;
      cursor: pointer;
    }

    .input-bar {
      padding: 16px 24px;
      display: flex;
      gap: 12px;
    }

    input {
      flex: 1;
      border: none;
      background: var(--grey);
      padding: 12px 16px;
      border-radius: 12px;
      font-size: 16px;
      outline: none;
      color: var(--text);
    }

    #sb {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100%;
      background: var(--bg);
      z-index: 201;
      transition: 0.3s;
      padding: 40px 24px;
    }

    .sb-link {
      display: block;
      padding: 16px 0;
      text-decoration: none;
      color: var(--text);
      font-size: 17px;
      font-weight: 500;
      border-bottom: 1px solid var(--border);
    }

    #ov {
      display: none;
      position: fixed;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.2);
      z-index: 200;
      backdrop-filter: blur(4px);
    }
  </style>
  <script>if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');</script>
</head>

<body>
  <nav class="top-nav">
    <div class="nav-title">NexHax</div><button onclick="tglM(1)"
      style="background:none; border:none; padding:8px; cursor:pointer; color:var(--text)"><svg width="24" height="24"
        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
        stroke-linejoin="round">
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg></button>
  </nav>
  <div id="ov" onclick="tglM(0)"></div>
  <div id="sb">
    <h2 style="margin-bottom:32px">Menú</h2><a href="dashboard.html" class="sb-link">Inicio</a><a href="chat.html"
      class="sb-link" style="color:var(--primary); font-weight:700">Chat Global</a><a href="shortener.html"
      class="sb-link">Acortador</a><a href="panel.html" class="sb-link">Panel Académico</a><a href="profile.html"
      class="sb-link">Perfil</a><button id="logoutBtn"
      style="margin-top:40px; border:none; background:none; color:#ff3b30; font-weight:600; cursor:pointer">Cerrar
      Sesión</button>
  </div>
  <div id="chat"></div>
  <div class="input-area">
    <div id="re-pre">
      <div class="re-box">
        <div class="re-u" id="re-u"></div>
        <div class="re-t" id="re-t"></div>
      </div>
      <div class="re-close" onclick="window.clearRe()">X</div>
    </div>
    <div class="input-bar"><input id="in" placeholder="Escribe..."
        onkeypress="if(event.key==='Enter')window.send()"><button onclick="window.send()"
        style="background:none; border:none; color:var(--primary); font-weight:600; cursor:pointer">Enviar</button>
    </div>
  </div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
    import { getDatabase, ref, push, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-database.js";
    const config = { apiKey: "AIzaSyDp6IB_ZndLgMWamLzThb5EBqClYSQf2LM", authDomain: "lozano-1690859356322.firebaseapp.com", databaseURL: "https://lozano-1690859356322-default-rtdb.firebaseio.com", projectId: "lozano-1690859356322" };
    const app = initializeApp(config);
    const auth = getAuth(app);
    const db = getDatabase(app);
    if (localStorage.getItem('theme') === 'dark') document.body.classList.add('dark');
    let mid = ""; let reTo = null;
    onAuthStateChanged(auth, (user) => { if (!user) window.location.href = "index.html"; else { mid = user.email.split('@')[0]; load(); } });
    function load() {
      onValue(ref(db, 'chat'), (snap) => {
        const c = document.getElementById("chat"); c.innerHTML = ""; const data = snap.val() || {};
        Object.keys(data).forEach(k => {
          const m = data[k]; const isM = m.user === mid; const canDel = isM && m.ts && (Date.now() - m.ts < 10000) && !m.deleted;
          let reH = m.re ? `<div class="re-box"><div class="re-u">${m.re.u}</div><div class="re-t">${m.re.t}</div></div>` : "";
          const msgText = m.deleted ? `<i style="opacity:0.6">Mensaje eliminado</i>` : m.text;
          const clickAction = m.deleted ? "" : `onclick="window.setRe('${m.user}','${m.text.replace(/'/g, "\\\\'")}')"`;
          c.innerHTML += `<div class="m ${isM ? 'me' : 'ot'}" ${clickAction}>${!isM ? '<div class="u">' + m.user + '</div>' : ''}${reH}<div>${msgText}</div><div class="t">${m.time} ${canDel ? `<span class="del-btn" onclick="event.stopPropagation();window.delMsg('${k}')">Borrar</span>` : ''}</div></div>`;
        });
        c.scrollTop = c.scrollHeight;
      });
    }
    window.send = async () => {
      const i = document.getElementById("in"); const v = i.value.trim(); if (!v) return;
      const m = { user: mid, text: v, time: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }), ts: Date.now(), re: reTo };
      i.value = ""; window.clearRe(); await push(ref(db, 'chat'), m);
    };
    window.delMsg = (k) => { if (confirm('¿Borrar mensaje?')) update(ref(db, `chat/${k}`), { text: "Mensaje eliminado", deleted: true, re: null }); };
    window.setRe = (u, t) => { reTo = { u, t }; document.getElementById("re-u").textContent = u; document.getElementById("re-t").textContent = t; document.getElementById("re-pre").style.display = "block"; document.getElementById("in").focus(); };
    window.clearRe = () => { reTo = null; document.getElementById("re-pre").style.display = "none"; };
    window.tglM = (s) => { document.getElementById("sb").style.left = s ? "0" : "-280px"; document.getElementById("ov").style.display = s ? "block" : "none"; };
    document.getElementById("logoutBtn").onclick = () => { signOut(auth); localStorage.clear(); };
  </script>
</body>

</html>